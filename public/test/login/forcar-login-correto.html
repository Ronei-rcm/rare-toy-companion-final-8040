<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>For√ßar Login Correto - MuhlStore</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        .login-form {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            background: #ff6b35;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
            transition: all 0.3s;
        }
        button:hover {
            background: #ff5722;
            transform: translateY(-2px);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .success { background: rgba(76, 175, 80, 0.3); border: 1px solid #4CAF50; }
        .error { background: rgba(244, 67, 54, 0.3); border: 1px solid #f44336; }
        .info { background: rgba(33, 150, 243, 0.3); border: 1px solid #2196F3; }
        .user-data {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê For√ßar Login Correto</h1>
        
        <div class="info status">
            <strong>‚ö†Ô∏è PROBLEMA IDENTIFICADO:</strong> O sistema est√° funcionando, mas voc√™ pode n√£o estar logado corretamente na interface.
        </div>

        <div class="login-form">
            <h3>üìù Fazer Login Corretamente:</h3>
            <input type="email" id="email" placeholder="Email" value="cliente@exemplo.com">
            <input type="password" id="password" placeholder="Senha" value="senha123">
            <button onclick="fazerLogin()">üîë Fazer Login</button>
        </div>

        <div id="status"></div>
        
        <div class="user-data">
            <h3>üìä Dados do Usu√°rio:</h3>
            <p><strong>Status:</strong> <span id="userStatus">Verificando...</span></p>
            <p><strong>Email:</strong> <span id="userEmail">-</span></p>
            <p><strong>ID:</strong> <span id="userId">-</span></p>
            <p><strong>Pedidos:</strong> <span id="pedidosCount">-</span></p>
            <p><strong>Endere√ßos:</strong> <span id="enderecosCount">-</span></p>
            <p><strong>Total Gasto:</strong> <span id="totalGasto">-</span></p>
        </div>

        <button onclick="verificarDados()">üîÑ Verificar Dados</button>
        <button onclick="irParaMinhaConta()">üè† Ir para Minha Conta</button>
        <button onclick="limparTudo()">üßπ Limpar Tudo e Recarregar</button>
    </div>

    <script>
        // Verificar dados do usu√°rio
        async function verificarDados() {
            const status = document.getElementById('status');
            status.innerHTML = '<div class="info status">üîÑ Verificando dados do usu√°rio...</div>';

            try {
                // Verificar se est√° logado
                const meResponse = await fetch('/api/auth/me', {
                    credentials: 'include'
                });
                
                if (meResponse.ok) {
                    const meData = await meResponse.json();
                    
                    if (meData.authenticated) {
                        document.getElementById('userStatus').textContent = '‚úÖ Logado';
                        document.getElementById('userEmail').textContent = meData.user.email;
                        document.getElementById('userId').textContent = meData.user.id;
                        
                        // Carregar estat√≠sticas
                        const statsResponse = await fetch('/api/customers/current/stats', {
                            credentials: 'include'
                        });
                        
                        if (statsResponse.ok) {
                            const statsData = await statsResponse.json();
                            document.getElementById('pedidosCount').textContent = statsData.totalPedidos;
                            document.getElementById('enderecosCount').textContent = statsData.enderecos;
                            document.getElementById('totalGasto').textContent = `R$ ${statsData.totalGasto.toFixed(2)}`;
                        }
                        
                        status.innerHTML = '<div class="success status">‚úÖ Usu√°rio logado corretamente! Dados carregados.</div>';
                    } else {
                        document.getElementById('userStatus').textContent = '‚ùå N√£o logado';
                        status.innerHTML = '<div class="error status">‚ùå Usu√°rio n√£o est√° logado. Fa√ßa login primeiro.</div>';
                    }
                } else {
                    status.innerHTML = '<div class="error status">‚ùå Erro ao verificar autentica√ß√£o.</div>';
                }
            } catch (error) {
                status.innerHTML = '<div class="error status">‚ùå Erro: ' + error.message + '</div>';
            }
        }

        // Fazer login
        async function fazerLogin() {
            const status = document.getElementById('status');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                status.innerHTML = '<div class="error status">‚ùå Preencha email e senha.</div>';
                return;
            }
            
            status.innerHTML = '<div class="info status">üîÑ Fazendo login...</div>';

            try {
                // Limpar dados anteriores
                localStorage.clear();
                sessionStorage.clear();
                
                // Fazer login
                const loginResponse = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        email: email,
                        senha: password
                    })
                });
                
                if (loginResponse.ok) {
                    const loginData = await loginResponse.json();
                    
                    if (loginData.success) {
                        status.innerHTML = '<div class="success status">‚úÖ Login realizado com sucesso!</div>';
                        
                        // Aguardar um pouco e verificar dados
                        setTimeout(() => {
                            verificarDados();
                        }, 1000);
                    } else {
                        status.innerHTML = '<div class="error status">‚ùå Falha no login: ' + (loginData.error || 'Erro desconhecido') + '</div>';
                    }
                } else {
                    status.innerHTML = '<div class="error status">‚ùå Erro no servidor: ' + loginResponse.status + '</div>';
                }
            } catch (error) {
                status.innerHTML = '<div class="error status">‚ùå Erro: ' + error.message + '</div>';
            }
        }

        // Ir para Minha Conta
        function irParaMinhaConta() {
            window.location.href = '/minha-conta?t=' + Date.now();
        }

        // Limpar tudo e recarregar
        async function limparTudo() {
            const status = document.getElementById('status');
            status.innerHTML = '<div class="info status">üßπ Limpando tudo...</div>';

            try {
                // Limpar Service Worker
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                    }
                }

                // Limpar caches
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    for (let cacheName of cacheNames) {
                        await caches.delete(cacheName);
                    }
                }

                // Limpar storage
                localStorage.clear();
                sessionStorage.clear();

                // Limpar cookies
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });

                status.innerHTML = '<div class="success status">‚úÖ Tudo limpo! Recarregando p√°gina...</div>';
                
                setTimeout(() => {
                    window.location.reload();
                }, 2000);

            } catch (error) {
                status.innerHTML = '<div class="error status">‚ùå Erro ao limpar: ' + error.message + '</div>';
            }
        }

        // Verificar dados ao carregar a p√°gina
        window.addEventListener('load', verificarDados);
    </script>
</body>
</html>
