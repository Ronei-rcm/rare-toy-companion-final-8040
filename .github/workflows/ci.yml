name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]

env:
  NODE_VERSION: '18.x'

jobs:
  # ============================================
  # JOB 1: Lint e FormataÃ§Ã£o
  # ============================================
  lint:
    name: ğŸ” Lint & Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¥ Instalar dependÃªncias
        run: npm ci
      
      - name: ğŸ” Executar ESLint
        run: npm run lint
        continue-on-error: true
      
      - name: ğŸ”§ Corrigir problemas ESLint (se possÃ­vel)
        run: npm run lint:fix || true

  # ============================================
  # JOB 2: Testes
  # ============================================
  test:
    name: ğŸ§ª Testes
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: ğŸ“¥ Instalar dependÃªncias
        run: npm ci
      
      - name: ğŸ§ª Executar testes
        run: npm test
        env:
          CI: true
      
      - name: ğŸ“Š Gerar relatÃ³rio de cobertura
        run: npm run test:coverage || echo "Cobertura nÃ£o configurada ainda"
        continue-on-error: true
      
      - name: ğŸ“¤ Upload coverage para Codecov (opcional)
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        continue-on-error: true

  # ============================================
  # JOB 3: Build
  # ============================================
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¥ Instalar dependÃªncias
        run: npm ci
      
      - name: ğŸ—ï¸ Build de produÃ§Ã£o
        run: npm run build:prod
        env:
          NODE_ENV: production
      
      - name: ğŸ“Š Verificar tamanho do build
        run: |
          echo "ğŸ“¦ Tamanho do diretÃ³rio dist:"
          du -sh dist/ || echo "DiretÃ³rio dist nÃ£o encontrado"
      
      - name: ğŸ’¾ Upload artifacts (build)
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

  # ============================================
  # JOB 4: SeguranÃ§a
  # ============================================
  security:
    name: ğŸ”’ AnÃ¡lise de SeguranÃ§a
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¥ Instalar dependÃªncias
        run: npm ci
      
      - name: ğŸ” NPM Audit
        run: npm audit --audit-level=moderate
        continue-on-error: true
      
      - name: ğŸ”’ Verificar senhas hardcoded
        run: |
          echo "ğŸ” Verificando senhas hardcoded..."
          if grep -r -i "password.*=" --include="*.js" --include="*.ts" --include="*.cjs" --include="*.yml" --include="*.yaml" . | grep -v "process.env" | grep -v ".env.example" | grep -v "node_modules" | grep -v ".git" | grep -v "test" | grep -v "RSM_Rg51gti66\|RareToy2025\|changeme\|default\|test\|demo"; then
            echo "âš ï¸ PossÃ­veis senhas hardcoded encontradas!"
            exit 1
          else
            echo "âœ… Nenhuma senha hardcoded encontrada"
          fi
        continue-on-error: true
      
      - name: ğŸ”’ Verificar variÃ¡veis de ambiente sensÃ­veis
        run: |
          echo "ğŸ” Verificando uso correto de variÃ¡veis de ambiente..."
          # Verificar se .env estÃ¡ no .gitignore
          if grep -q "\.env$" .gitignore; then
            echo "âœ… .env estÃ¡ no .gitignore"
          else
            echo "âš ï¸ .env nÃ£o estÃ¡ no .gitignore!"
            exit 1
          fi

  # ============================================
  # JOB 5: Deploy (Apenas na branch main)
  # ============================================
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    needs: [build, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts
          path: dist/
      
      - name: ğŸ“ Preparar deploy
        run: |
          echo "ğŸš€ Preparando deploy..."
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
      
      # Descomente e configure conforme seu ambiente de deploy
      # - name: ğŸš€ Deploy para servidor
      #   uses: appleboy/scp-action@master
      #   with:
      #     host: ${{ secrets.DEPLOY_HOST }}
      #     username: ${{ secrets.DEPLOY_USER }}
      #     key: ${{ secrets.DEPLOY_SSH_KEY }}
      #     source: "dist/*"
      #     target: "/var/www/muhlstore"
      
      # - name: ğŸ”„ Restart PM2
      #   uses: appleboy/ssh-action@master
      #   with:
      #     host: ${{ secrets.DEPLOY_HOST }}
      #     username: ${{ secrets.DEPLOY_USER }}
      #     key: ${{ secrets.DEPLOY_SSH_KEY }}
      #     script: |
      #       cd /var/www/muhlstore
      #       pm2 restart all

