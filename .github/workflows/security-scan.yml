name: üîí Security Scan

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  schedule:
    # Executa toda segunda-feira √†s 9h UTC
    - cron: '0 9 * * 1'

jobs:
  security-scan:
    name: üîí An√°lise de Seguran√ßa
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necess√°rio para truffleHog
      
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
      
      - name: üì• Instalar depend√™ncias
        run: npm ci
      
      - name: üîç NPM Audit
        run: |
          echo "üîç Executando NPM Audit..."
          npm audit --audit-level=moderate || true
      
      - name: üîí Verificar senhas e secrets no c√≥digo
        run: |
          echo "üîç Procurando por senhas e secrets hardcoded..."
          
          # Lista de padr√µes suspeitos
          PATTERNS=(
            "password.*=.*['\"][^'\"]*['\"]"
            "PASSWORD.*=.*['\"][^'\"]*['\"]"
            "senha.*=.*['\"][^'\"]*['\"]"
            "token.*=.*['\"][^'\"]*['\"]"
            "TOKEN.*=.*['\"][^'\"]*['\"]"
            "secret.*=.*['\"][^'\"]*['\"]"
            "SECRET.*=.*['\"][^'\"]*['\"]"
            "api[_-]?key.*=.*['\"][^'\"]*['\"]"
            "apikey.*=.*['\"][^'\"]*['\"]"
          )
          
          FOUND_SECRETS=false
          
          for pattern in "${PATTERNS[@]}"; do
            if grep -r -i -E "$pattern" \
              --include="*.js" \
              --include="*.ts" \
              --include="*.cjs" \
              --include="*.tsx" \
              --include="*.yml" \
              --include="*.yaml" \
              --exclude-dir=node_modules \
              --exclude-dir=.git \
              --exclude-dir=dist \
              --exclude-dir=coverage \
              --exclude="*.test.*" \
              --exclude="*.spec.*" \
              --exclude=".env.example" \
              . | grep -v "process.env" | grep -v "process\['env'\]"; then
              
              echo "‚ö†Ô∏è ATEN√á√ÉO: Poss√≠vel secret encontrado com padr√£o: $pattern"
              FOUND_SECRETS=true
            fi
          done
          
          if [ "$FOUND_SECRETS" = true ]; then
            echo "‚ùå Poss√≠veis secrets encontrados! Revise o c√≥digo acima."
            exit 1
          else
            echo "‚úÖ Nenhum secret hardcoded encontrado"
          fi
      
      - name: üîí Verificar arquivos sens√≠veis no Git
        run: |
          echo "üîç Verificando se arquivos sens√≠veis est√£o sendo commitados..."
          
          SENSITIVE_FILES=(
            ".env"
            ".env.local"
            ".env.production"
            "*.pem"
            "*.key"
            "*.p12"
            "*.pfx"
            "id_rsa"
            "id_ed25519"
          )
          
          for pattern in "${SENSITIVE_FILES[@]}"; do
            if git ls-files | grep -E "$pattern"; then
              echo "‚ö†Ô∏è ATEN√á√ÉO: Arquivo sens√≠vel encontrado no Git: $pattern"
              echo "‚ùå Arquivos sens√≠veis n√£o devem ser commitados!"
              exit 1
            fi
          done
          
          echo "‚úÖ Nenhum arquivo sens√≠vel encontrado no Git"
      
      - name: üîí Verificar .gitignore
        run: |
          echo "üîç Verificando .gitignore..."
          
          REQUIRED_IGNORES=(
            ".env"
            ".env.local"
            ".env.production"
            "*.log"
            "node_modules"
            "dist"
            "coverage"
          )
          
          if [ ! -f .gitignore ]; then
            echo "‚ùå Arquivo .gitignore n√£o encontrado!"
            exit 1
          fi
          
          for ignore in "${REQUIRED_IGNORES[@]}"; do
            if grep -q "^$ignore$" .gitignore || grep -q "^$ignore/" .gitignore; then
              echo "‚úÖ $ignore est√° no .gitignore"
            else
              echo "‚ö†Ô∏è $ignore N√ÉO est√° no .gitignore"
            fi
          done

